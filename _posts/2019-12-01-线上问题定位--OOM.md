---
layout: post
title:  "线上问题定位--OOM"
date:   2019-02-11 10:13:38 +0800
categories: 线上问题定位
---


* content
{:toc}

问题描述				{#problem}
=============================

<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">服务器上部署了Java服务，出现了OutOfMemoryError，问题应该如何定位?</span></p>

解决思路				{#jiejuesilu}
=============================


<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">Java服务OOM，最常见的原因为：</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">有可能是内存分配确实过小，而正常业务使用了大量内存</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">某一个对象被频繁申请，却没有释放，内存不断泄漏，导致内存耗尽</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">某一个资源被频繁申请，系统资源耗尽，例如：不断创建线程，不断发起网络连接</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">更具体的，可以使用以下的一些工具逐一排查。</span></p>

一、查发生了OOM的进程				{#one}
=============================

<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">工具：top</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">方法：</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">执行top -d 1&nbsp;-c，每秒刷新一次，显示进程运行信息列表</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">键入M&nbsp;(大写m)，进程按照内存使用排序</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">图示：</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdaxYmtzriaHQ1FjkDMwVZDYw8w8rH630Pf84HiaOlwial24UYAg3qfeMgQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.17816683831101957" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdaxYmtzriaHQ1FjkDMwVZDYw8w8rH630Pf84HiaOlwial24UYAg3qfeMgQ/640?wx_fmt=png" data-type="png" data-w="971" data-fail="0" /></span></p>


二、确认是不是内存本身就分配过小			{#two}
=============================

<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">方法：jmap&nbsp;-heap&nbsp;2820</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdDBNx3Qv9p6aiaypvNX2QUF32LPSRfXIlPTH9eJukUBFDnTtLGe730ZA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="1.2887473460721868" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdDBNx3Qv9p6aiaypvNX2QUF32LPSRfXIlPTH9eJukUBFDnTtLGe730ZA/640?wx_fmt=png" data-type="png" data-w="471" data-fail="0" /></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">如上图，可以查看新生代，老生代堆内存的分配大小以及使用情况，看是否本身分配过小。</span></p>


三、找到最耗内存的对象			{#three}
=============================

<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">方法：jmap&nbsp;-histo:live&nbsp;2820&nbsp;|&nbsp;more&nbsp;</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">图示：</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdpZF5Vtnstcv8m6o6Miak264BUm6TYXl8VTd7BJ9vwkTNfMlaA3Dbplg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.6350974930362117" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdpZF5Vtnstcv8m6o6Miak264BUm6TYXl8VTd7BJ9vwkTNfMlaA3Dbplg/640?wx_fmt=png" data-type="png" data-w="718" data-fail="0" /></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">如上图，输入命令后，会以表格的形式显示存活对象的信息，并按照所占内存大小排序：</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">实例数</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">所占内存大小</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">类名</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">是不是很直观?对于实例数较多，占用内存大小较多的实例/类，相关的代码就要针对性review了。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">上图中占内存最多的对象是byte，共占用内存71M，值得关注，后续再MAT中再次分析。</span></p>

四、确认是否是资源耗尽			{#four}
=============================

<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">查看进程创建的线程数，如果资源耗尽，也可能出现OOM。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">工具：</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">ps</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">方法：ps -efL 2820</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdcCXP3smcu8eP4rzhAmicHOhSRn8jw8nuQ6r7aj7yqDIz04fiboKnvBVA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.3930957683741648" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdcCXP3smcu8eP4rzhAmicHOhSRn8jw8nuQ6r7aj7yqDIz04fiboKnvBVA/640?wx_fmt=png" data-type="png" data-w="898" data-fail="0" /></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">查看进程网络连接数，如果资源耗尽，也可能出现OOM。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">工具：</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">netstat</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">方法：netstat -apn | grep 2820</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdgt5kS1dP9126CrY8hrIPCN3FpYVIdfbaO9vibmaZWE6nEdbUTlicFzwQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.14685314685314685" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdgt5kS1dP9126CrY8hrIPCN3FpYVIdfbaO9vibmaZWE6nEdbUTlicFzwQ/640?wx_fmt=png" data-type="png" data-w="858" data-fail="0" /></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">这里介绍另一种方法，通过</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">/proc/${PID}/fd&nbsp;</span></p>
</li>
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">/proc/${PID}/task&nbsp;</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">可以分别查看句柄详情和线程数。</span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">例如，某一台线上服务器的sshd进程PID是2820，查看</span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">ll&nbsp;/proc/2820/fd&nbsp;</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdABianqYqUwniaXVRWMwhk4Vx9rBoOulFXOK1o3UtXcvfe6G7v7otqytQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.5132743362831859" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdABianqYqUwniaXVRWMwhk4Vx9rBoOulFXOK1o3UtXcvfe6G7v7otqytQ/640?wx_fmt=png" data-type="png" data-w="791" data-fail="0" /></span></p>
<ul class="list-paddingleft-2">
<li>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">ll&nbsp;/proc/2820/task&nbsp;</span></p>
</li>
</ul>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdlbKExXHrPx8fDukKnBjL4QuAJc7pia69WuMmxsNgHttiaCU0Yy53gW3g/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="" data-copyright="0" data-ratio="0.795959595959596" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yNV7KSicILb5WI24aib3KWVFaw62RBlMEdlbKExXHrPx8fDukKnBjL4QuAJc7pia69WuMmxsNgHttiaCU0Yy53gW3g/640?wx_fmt=png" data-type="png" data-w="495" data-fail="0" /></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">&nbsp;</span></p>


致谢！             {#thanks}
===========================

<p>&nbsp; &nbsp; &nbsp; &nbsp;至此，我们完成了开发编译调试到最终上线生产运行。喜欢请关注公众号--程序猿牧场，谢谢！</p>
<p>&nbsp;<img src="https://img2020.cnblogs.com/blog/440176/202003/440176-20200316224639427-719739537.png" alt="" /></p>