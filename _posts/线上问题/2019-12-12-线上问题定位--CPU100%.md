---
layout: post
title:  "线上问题定位--CPU100%"
date:   2019-02-12 19:13:38 +0800
categories: 线上问题定位
---

* content
{:toc}

问题描述				{#problem}
=============================

<p>服务器CPU突然告警，如何定位是哪个服务进程导致CPU过载，哪个线程导致CPU过载，哪段代码导致CPU过载？</p>
<p>&nbsp;</p>

步骤一、找到最耗CPU的进程				{#one}
=============================

<p>工具：top</p>
<p>方法：</p>
<ul class="list-paddingleft-2">
<li>
<p>执行top -d 1&nbsp;-c，每秒刷新一次，显示进程运行信息列表</p>
</li>
<li>
<p>键入P&nbsp;(大写p)，进程按照CPU使用率排序</p>
</li>
</ul>
<p>图示：</p>

![/source/线上问题定位--CPU100/1.png]({{ '/source/线上问题定位--CPU100/1.png' | prepend: site.baseurl  }})

<p>如上图，最耗CPU的进程PID为1802</p>
<p>&nbsp;</p>

步骤二：找到最耗CPU的线程				{#two}
=============================

<p>工具：top</p>
<p>方法：</p>
<ul class="list-paddingleft-2">
<li>
<p>top -d 1 -Hp 1802，显示一个进程的线程运行信息列表</p>
</li>
<li>
<p>键入P&nbsp;(大写p)，线程按照CPU使用率排序</p>
</li>
</ul>
<p>图示：</p>

![/source/线上问题定位--CPU100/2.png]({{ '/source/线上问题定位--CPU100/2.png' | prepend: site.baseurl  }})

<p>如上图，进程1802内，最耗CPU的线程PID为1826</p>
<p>&nbsp;</p>

步骤三：将线程PID转化为16进制				{#three}
=============================

<p>工具：计算器</p>

![/source/线上问题定位--CPU100/3.png]({{ '/source/线上问题定位--CPU100/3.png' | prepend: site.baseurl  }})

<p>&nbsp;</p>
<p>之所以要转化为16进制，是因为堆栈里，线程id是用16进制表示的。</p>
<p>&nbsp;</p>


步骤四：查看堆栈，找到线程在干嘛				{#four}
=============================


<p>工具：jstack/grep</p>
<p>方法：jstack 1802 | grep &lsquo;722&rsquo; -C5</p>
<ul class="list-paddingleft-2">
<li>
<p>打印进程堆栈</p>
</li>
<li>
<p>通过线程id，过滤得到线程堆栈</p>
</li>
</ul>
<p>图示：</p>

![/source/线上问题定位--CPU100/4.png]({{ '/source/线上问题定位--CPU100/4.png' | prepend: site.baseurl  }})

<p>如上图，找到了耗CPU高的线程对应的线程名称&ldquo;http-nio-10287-exec-10&rdquo;，以及看到了该线程正在执行代码的堆栈。</p>
<p>&nbsp;</p>
<p>按照这几个步骤，大多数的CPU 100%问题都可以定位到，欢迎大家留言交流。</p>


致谢！             {#thanks}
===========================

<p>&nbsp; &nbsp; &nbsp; &nbsp;至此，我们完成了开发编译调试到最终上线生产运行。喜欢请关注公众号--程序猿牧场，谢谢！</p>
<p>&nbsp;<img src="https://img2020.cnblogs.com/blog/440176/202003/440176-20200316224639427-719739537.png" alt="" /></p>